package fsm;

import Ontology.Movie;
import Ontology.SeeMovie;
import agents.AgentNegotiator;

import jade.content.ContentElement;
import jade.content.lang.Codec.CodecException;
import jade.content.onto.OntologyException;
import jade.content.onto.basic.Action;

import jade.core.behaviours.Behaviour;
import jade.lang.acl.ACLMessage;


/*
   Tiene que obtener la propuesta del datastore 
*/
public class EvaluarPropuestaBehaviour extends Behaviour {
	
	private int event;
	public static String FINAL_MOVIE = "";
	@Override
	public void action() {
		ACLMessage prop = (ACLMessage)this.getDataStore().get(MCPBehaviour.PROPUESTA);
		String pelicula_propuest = "";
		try {
			ContentElement ce = null;
				ce = myAgent.getContentManager().extractContent(prop);
				Action p = (Action)ce;
				SeeMovie seemovie = (SeeMovie)p.getAction();
				Movie mov = seemovie.getMovie();
				pelicula_propuest =  mov.getName();
				if (prop.getPerformative() == ACLMessage.CANCEL) {
					event = 2;
					return;
				}
				System.out.println(((AgentNegotiator)myAgent).getNombre() + " is evaluating the proposal");
				
				
				//Utilities calculation 
				
				double uCurrentMovie = ((AgentNegotiator)myAgent).getRatingPropuestaActual();
				double uProposedMovie= ((AgentNegotiator)myAgent).getRating(pelicula_propuest);
				
				System.out.println("  Utility of the current proposal   =  " + uCurrentMovie + " , movie = " +((AgentNegotiator)myAgent).getActualMovie());
				System.out.println("  Utility of the proposal received =  " + uProposedMovie+ " , movie = " + pelicula_propuest); //pelicula_propuesta.getContent()
				
				// Evaluation of the proposal
				if (uCurrentMovie <= uProposedMovie) 
				{ 	
					ACLMessage accept = prop.createReply();
					accept.setPerformative(ACLMessage.ACCEPT_PROPOSAL);
					FINAL_MOVIE = pelicula_propuest;
					myAgent.send(accept);
					event = 1;
					System.out.println("The proposal has been accepted by "+ ((AgentNegotiator)myAgent).getNombre());
				}
				else {
					
					ACLMessage accept = prop.createReply();
					accept.setPerformative(ACLMessage.REJECT_PROPOSAL);
					myAgent.send(accept);
					event = 0;
					System.out.println("The proposal has been rejected by " + ((AgentNegotiator)myAgent).getNombre());
				}
		}
		catch (CodecException ce) {
			ce.printStackTrace();
		}
		catch (OntologyException oe) {
			oe.printStackTrace();
		}
		

			
	}

	@Override
	public boolean done() {
		return true; //It will always return true because it does not have to wait for any messages
	}
	
	@Override
	public int onEnd() {
		return event;
	}

}
